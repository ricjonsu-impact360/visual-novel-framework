<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Previewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #2c5aa0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 2px solid rgba(255, 107, 53, 0.2);
        }

        .header {
            background: #fa8155;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab.active {
            background: white;
            color: #2c5aa0;
            border-bottom: 3px solid #ff6b35;
        }

        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
            font-size: 1.2em;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sound-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .sound-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .sound-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .sound-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
            word-break: break-word;
        }

        .sound-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #ff6b35, #ff8c42);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 95px;
            height: 40px;
            justify-content: center;
            flex-shrink: 0;
        }

        .play-btn {
            background: linear-gradient(135deg, #ff6b35, #ff8c42);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 95px;
            height: 40px;
            justify-content: center;
            flex-shrink: 0;
        }

        .play-icon {
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .play-text {
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            width: 60px;
            text-align: left;
        }

        .play-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .play-btn.playing {
            background: linear-gradient(135deg, #2c5aa0, #4a7bc8);
        }

        .copy-id-btn {
            background: linear-gradient(135deg, #28a745, #34ce57);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            flex-shrink: 0;
            margin-left: 5px;
        }

        .copy-id-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .copy-id-btn.copied {
            background: linear-gradient(135deg, #007bff, #0056b3);
        }

        .volume-control {
            flex: 1;
            margin-left: 10px;
        }

        .volume-slider {
            width: 100%;
            height: 5px;
            border-radius: 5px;
            background: #dee2e6;
            outline: none;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #ff6b35;
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #ff6b35;
            cursor: pointer;
            border: none;
        }

        #globalVolume {
            -webkit-appearance: none;
            appearance: none;
        }

        #globalVolume::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        #globalVolume::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .stats {
            background: linear-gradient(135deg, rgba(44, 90, 160, 0.1), rgba(255, 107, 53, 0.1));
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            color: #2c5aa0;
            font-weight: 600;
            border: 1px solid rgba(255, 107, 53, 0.2);
        }

        .search-box {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1.1em;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .no-results {
            text-align: center;
            padding: 50px;
            color: #6c757d;
            font-size: 1.2em;
        }

        /* Bottom Playback Control Bar */
        .playback-control {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #2c5aa0 0%, #ff6b35 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 20px;
            backdrop-filter: blur(10px);
        }

        .playback-control.active {
            display: flex;
        }

        .playback-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 0;
        }

        .playback-artwork {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .playback-details {
            flex: 1;
            min-width: 0;
        }

        .playback-title {
            font-weight: 600;
            font-size: 1em;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playback-type {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .playback-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .playback-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .playback-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .playback-btn.main {
            background: white;
            color: #2c5aa0;
            width: 50px;
            height: 50px;
            font-size: 24px;
        }

        .playback-btn.main:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        .playback-btn.copied {
            background: linear-gradient(135deg, #007bff, #0056b3);
        }

        .playback-volume {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 150px;
        }

        .playback-volume-slider {
            width: 100px;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .playback-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .playback-volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .playback-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 2;
            max-width: 400px;
        }

        .playback-time {
            font-size: 0.8em;
            min-width: 35px;
            text-align: center;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s ease;
        }

        /* Adjust body padding to account for fixed bottom bar */
        body {
            padding-bottom: 80px;
        }
    </style>
</head>
<body>
     <button class="btn" onclick="
        if (window.history.length > 1&&document.referrer.split('/').pop()=='character-preview.html') {
            window.history.back();
        }
        else{
            window.location.href='character-preview.html'
        }    
    " 
    style="
        width: auto;
        margin: 5px;
    ">Go to Character Preview</button>
    <div class="container">
        <div class="header">
            <h1>ðŸŽµ Audio Previewer</h1>
            <p>Preview BGM and SFX audio files</p>
            <p>Open <b>audio-scanner.php</b> to change the base path</p>
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-top: 15px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="material-icons" style="font-size: 20px;">volume_up</span>
                    <span style="font-size: 0.9em; min-width: 60px;">Global Volume:</span>
                    <input type="range" id="globalVolume" min="0" max="100" value="50"
                           oninput="setGlobalVolume(this.value)" style="
                        width: 120px;
                        height: 6px;
                        border-radius: 3px;
                        background: rgba(255, 255, 255, 0.3);
                        outline: none;
                        -webkit-appearance: none;
                    ">
                    <span id="globalVolumeText" style="font-size: 0.8em; min-width: 30px;">50%</span>
                </div>
                <button onclick="refreshAudioFiles()" style="
                    background: rgba(255, 255, 255, 0.2);
                    color: white;
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    padding: 8px 16px;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 0.9em;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'"
                   onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                    ðŸ”„ Refresh File List
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('bgm')">
                ðŸŽ¼ Background Music (BGM)
            </button>
            <button class="tab" onclick="switchTab('sfx')">
                ðŸ”Š Sound Effects (SFX)
            </button>
        </div>

        <div id="bgm-content" class="tab-content active">
            <input type="text" class="search-box" placeholder="Search BGM files..." onkeyup="filterSounds('bgm', this.value)">
            <div class="stats" id="bgm-stats">Loading BGM files...</div>
            <div class="loading" id="bgm-loading">Loading background music files...</div>
            <div class="sound-grid" id="bgm-grid"></div>
        </div>

        <div id="sfx-content" class="tab-content">
            <input type="text" class="search-box" placeholder="Search SFX files..." onkeyup="filterSounds('sfx', this.value)">
            <div class="stats" id="sfx-stats">Loading SFX files...</div>
            <div class="loading" id="sfx-loading">Loading sound effect files...</div>
            <div class="sound-grid" id="sfx-grid"></div>
        </div>
    </div>

    <!-- Bottom Playback Control Bar -->
    <div class="playback-control" id="playbackControl">
        <div class="playback-info">
            <div class="playback-artwork">
                <span class="material-icons" style="font-size: 24px;">music_note</span>
            </div>
            <div class="playback-details">
                <div class="playback-title" id="playbackTitle">No track selected</div>
                <div class="playback-type" id="playbackType">BGM</div>
            </div>
        </div>

        <div class="playback-controls">
            <button class="playback-btn main" id="playbackMainBtn" onclick="togglePlaybackControl()" title="Play/Pause">
                <span class="material-icons">play_arrow</span>
            </button>
            <button class="playback-btn" id="playbackCopyBtn" onclick="copyAudioId(currentTrackInfo ? currentTrackInfo.path : '', this)" title="Copy audio ID (filename)">
                <span class="material-icons">content_copy</span>
            </button>
        </div>

        <div class="playback-progress">
            <span class="playback-time" id="currentTime">0:00</span>
            <div class="progress-bar" onclick="seekTo(event)">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <span class="playback-time" id="totalTime">0:00</span>
        </div>

        <div class="playback-volume">
            <span class="material-icons" style="font-size: 18px;">volume_up</span>
            <input type="range" class="playback-volume-slider" id="playbackVolume" min="0" max="100" value="50"
                   oninput="setPlaybackVolume(this.value)">
        </div>
    </div>

    <script>
        let currentHowl = null;
        let currentButton = null;
        let globalVolumeLevel = 0.5; // Default global volume (50%)
        let soundFiles = {
            bgm: [],
            sfx: []
        };
        let filteredSounds = {
            bgm: [],
            sfx: []
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadSoundFiles();

            // Restore last opened tab from localStorage
            const lastTab = localStorage.getItem('audioPreviewerLastTab');
            if (lastTab && (lastTab === 'bgm' || lastTab === 'sfx')) {
                // Only switch if it's not already the active tab
                if (lastTab !== 'bgm') {
                    switchTab(lastTab);
                }
            }
        });

        // Switch between tabs
        function switchTab(tabName) {
            // Save current tab to localStorage
            localStorage.setItem('audioPreviewerLastTab', tabName);

            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                // Add active class to the matching tab
                if (tab.onclick && tab.onclick.toString().includes(`switchTab('${tabName}')`)) {
                    tab.classList.add('active');
                }
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-content').classList.add('active');

            // Stop any currently playing audio
            stopCurrentAudio();
        }

        // Load sound files from directories using PHP backend
        async function loadSoundFiles() {
            try {
                // Show loading state
                document.getElementById('bgm-loading').style.display = 'block';
                document.getElementById('sfx-loading').style.display = 'block';
                
                // Fetch file list from PHP backend
                const response = await fetch('audio-scanner.php');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load audio files');
                }
                
                // Process BGM files
                soundFiles.bgm = data.bgm || [];
                filteredSounds.bgm = [...soundFiles.bgm];
                document.getElementById('bgm-loading').style.display = 'none';
                updateStats('bgm');
                renderSounds('bgm');
                
                // Process SFX files
                soundFiles.sfx = data.sfx || [];
                filteredSounds.sfx = [...soundFiles.sfx];
                document.getElementById('sfx-loading').style.display = 'none';
                updateStats('sfx');
                renderSounds('sfx');
                
                // Log summary
                console.log('Audio files loaded:', data.summary);
                
            } catch (error) {
                console.error('Error loading sound files:', error);
                document.getElementById('bgm-loading').style.display = 'none';
                document.getElementById('sfx-loading').style.display = 'none';
                
                // Show fallback message
                showError('bgm', `Failed to load BGM files dynamically. Error: ${error.message}<br><br>
                    <strong>Requirements:</strong><br>
                    â€¢ PHP server must be running<br>
                    â€¢ audio-scanner.php must be accessible<br>
                    â€¢ ../v2-visual-novel-assets/audio/bgm directory must exist`);
                    
                showError('sfx', `Failed to load SFX files dynamically. Error: ${error.message}<br><br>
                    <strong>Requirements:</strong><br>
                    â€¢ PHP server must be running<br>
                    â€¢ audio-scanner.php must be accessible<br>
                    â€¢ ../v2-visual-novel-assets/audio/sfx directory must exist`);
            }
        }

        // Update statistics display
        function updateStats(type) {
            const count = filteredSounds[type].length;
            const total = soundFiles[type].length;
            const statsElement = document.getElementById(type + '-stats');
            
            if (count === total) {
                statsElement.textContent = `Found ${count} ${type.toUpperCase()} file${count !== 1 ? 's' : ''}`;
            } else {
                statsElement.textContent = `Showing ${count} of ${total} ${type.toUpperCase()} file${total !== 1 ? 's' : ''}`;
            }
        }

        // Render sound items
        function renderSounds(type) {
            const grid = document.getElementById(type + '-grid');
            const sounds = filteredSounds[type];

            if (sounds.length === 0) {
                grid.innerHTML = `<div class="no-results">No ${type.toUpperCase()} files found in the directory.</div>`;
                return;
            }

            grid.innerHTML = sounds.map((sound, index) => {
                const soundId = `${type}_${index}`;
                const alternatives = sound.alternatives ?
                    `<div style="font-size: 0.7em; color: #28a745; margin-top: 2px;">
                        Also available: ${sound.alternatives.map(alt => alt.extension.toUpperCase()).join(', ')}
                    </div>` : '';
                
                return `
                    <div class="sound-item">
                        <div class="sound-name" title="${sound.name}">${sound.displayName}</div>
                        <div class="sound-controls">
                            <button class="play-btn" id="btn_${soundId}" onclick="togglePlay('${sound.path}', '${soundId}', this)">
                                <span class="play-icon material-icons">play_arrow</span>
                                <span class="play-text">Play</span>
                            </button>
                            <button class="copy-id-btn" onclick="copyAudioId('${sound.name}', this)" title="Copy audio ID (filename)">
                                <span class="material-icons">content_copy</span>
                            </button>
                            <div class="volume-control">
                                <input type="range" class="volume-slider" id="vol_${soundId}" min="0" max="100" value="50"
                                       oninput="setVolume('${soundId}', this.value)">
                            </div>
                        </div>
                        <div style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">
                            ${formatFileSize(sound.size || 0)}${alternatives}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Format file size for display
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Toggle play/pause for audio using Howler.js
        function togglePlay(audioPath, soundId, button) {
            if (currentHowl && currentButton === button) {
                // Same audio - toggle play/pause
                if (currentHowl.playing()) {
                    currentHowl.pause();
                    updatePlayButton(button, false);
                } else {
                    currentHowl.play();
                    updatePlayButton(button, true);
                }
            } else {
                // Different audio - stop current and play new
                stopCurrentAudio();
                
                // Create new Howl instance
                currentHowl = new Howl({
                    src: [audioPath],
                    volume: globalVolumeLevel,
                    onplay: function() {
                        updatePlayButton(button, true);
                        updatePlaybackButton(true);
                        currentButton = button;
                    },
                    onpause: function() {
                        updatePlayButton(button, false);
                        updatePlaybackButton(false);
                    },
                    onend: function() {
                        updatePlayButton(button, false);
                        updatePlaybackButton(false);
                        currentButton = null;
                        currentHowl = null;
                    },
                    onloaderror: function(id, error) {
                        console.error('Error loading audio:', error);
                        alert('Error loading audio file: ' + audioPath);
                        updatePlayButton(button, false);
                        updatePlaybackButton(false);
                        currentButton = null;
                        currentHowl = null;
                    },
                    onplayerror: function(id, error) {
                        console.error('Error playing audio:', error);
                        alert('Error playing audio file. The file may not exist or be accessible.');
                        updatePlayButton(button, false);
                        updatePlaybackButton(false);
                        currentButton = null;
                        currentHowl = null;
                    }
                });
                
                // Set initial volume from slider (combined with global volume)
                const volumeSlider = document.getElementById('vol_' + soundId);
                if (volumeSlider) {
                    const individualVolume = volumeSlider.value / 100;
                    currentHowl.volume(globalVolumeLevel * individualVolume);
                } else {
                    currentHowl.volume(globalVolumeLevel);
                }
                
                // Play the audio
                currentHowl.play();
            }
        }

        // Update play button appearance
        function updatePlayButton(button, isPlaying) {
            const icon = button.querySelector('.play-icon');
            const text = button.querySelector('.play-text');
            
            if (isPlaying) {
                button.classList.add('playing');
                icon.textContent = 'pause';
                text.textContent = 'Pause';
            } else {
                button.classList.remove('playing');
                icon.textContent = 'play_arrow';
                text.textContent = 'Play';
            }
        }

        // Stop currently playing audio
        function stopCurrentAudio() {
            if (currentHowl) {
                currentHowl.stop();
                currentHowl.unload();
                currentHowl = null;
            }
            
            if (currentButton) {
                updatePlayButton(currentButton, false);
                currentButton = null;
            }
            
            // Reset all play buttons to be safe
            document.querySelectorAll('.play-btn').forEach(btn => {
                updatePlayButton(btn, false);
            });
        }

        // Set global volume control
        function setGlobalVolume(volume) {
            globalVolumeLevel = volume / 100;
            document.getElementById('globalVolumeText').textContent = volume + '%';
            
            // Sync with bottom playback control volume slider
            document.getElementById('playbackVolume').value = volume;
            
            // Apply to currently playing audio
            if (currentHowl) {
                // Get the individual volume slider value
                const currentButton = document.querySelector('.play-btn.playing');
                if (currentButton) {
                    const soundId = currentButton.id.replace('btn_', '');
                    const individualSlider = document.getElementById('vol_' + soundId);
                    if (individualSlider) {
                        const individualVolume = individualSlider.value / 100;
                        currentHowl.volume(globalVolumeLevel * individualVolume);
                    } else {
                        currentHowl.volume(globalVolumeLevel);
                    }
                } else {
                    // If no current button (replaying from playback control), just use global volume
                    currentHowl.volume(globalVolumeLevel);
                }
            }
        }

        // Set volume for current audio (combines global and individual volume)
        function setVolume(soundId, volume) {
            if (currentHowl) {
                const individualVolume = volume / 100;
                currentHowl.volume(globalVolumeLevel * individualVolume);
            }
        }

        // Filter sounds based on search input
        function filterSounds(type, searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            
            if (term === '') {
                filteredSounds[type] = [...soundFiles[type]];
            } else {
                filteredSounds[type] = soundFiles[type].filter(sound => 
                    sound.name.toLowerCase().includes(term) || 
                    sound.displayName.toLowerCase().includes(term)
                );
            }
            
            updateStats(type);
            renderSounds(type);
        }

        // Show error message
        function showError(type, message) {
            const grid = document.getElementById(type + '-grid');
            grid.innerHTML = `<div class="error-message">${message}</div>`;
            
            const stats = document.getElementById(type + '-stats');
            stats.textContent = 'Error loading files';
            stats.style.background = '#f8d7da';
            stats.style.color = '#721c24';
        }

        // Add refresh functionality
        function refreshAudioFiles() {
            // Reset loading states
            document.getElementById('bgm-loading').style.display = 'block';
            document.getElementById('sfx-loading').style.display = 'block';
            document.getElementById('bgm-stats').textContent = 'Loading BGM files...';
            document.getElementById('sfx-stats').textContent = 'Loading SFX files...';
            
            // Clear current data
            soundFiles.bgm = [];
            soundFiles.sfx = [];
            filteredSounds.bgm = [];
            filteredSounds.sfx = [];
            
            // Reload files
            loadSoundFiles();
        }

        // Bottom playback control variables
        let currentTrackInfo = null;
        let currentPlaylist = [];
        let currentTrackIndex = -1;
        let progressInterval = null;

        // Show/hide bottom playback control
        function showPlaybackControl(trackInfo) {
            currentTrackInfo = trackInfo;
            document.getElementById('playbackControl').classList.add('active');
            document.getElementById('playbackTitle').textContent = trackInfo.displayName;
            document.getElementById('playbackType').textContent = trackInfo.type.toUpperCase();
            
            // Sync playback volume with global volume
            document.getElementById('playbackVolume').value = globalVolumeLevel * 100;
            
            // Start progress tracking
            startProgressTracking();
        }

        function hidePlaybackControl() {
            document.getElementById('playbackControl').classList.remove('active');
            currentTrackInfo = null;
            stopProgressTracking();
        }

        // Toggle playback from bottom control
        function togglePlaybackControl() {
            if (currentHowl) {
                if (currentHowl.playing()) {
                    currentHowl.pause();
                    updatePlaybackButton(false);
                    if (currentButton) {
                        updatePlayButton(currentButton, false);
                    }
                } else {
                    currentHowl.play();
                    updatePlaybackButton(true);
                    if (currentButton) {
                        updatePlayButton(currentButton, true);
                    }
                }
            } else if (currentTrackInfo && currentTrackInfo.path) {
                // Recreate Howl instance if it was destroyed but we still have track info
                currentHowl = new Howl({
                    src: [currentTrackInfo.path],
                    volume: globalVolumeLevel,
                    onplay: function() {
                        updatePlaybackButton(true);
                        if (currentButton) {
                            updatePlayButton(currentButton, true);
                        }
                    },
                    onpause: function() {
                        updatePlaybackButton(false);
                        if (currentButton) {
                            updatePlayButton(currentButton, false);
                        }
                    },
                    onend: function() {
                        updatePlaybackButton(false);
                        if (currentButton) {
                            updatePlayButton(currentButton, false);
                        }
                        currentButton = null;
                        currentHowl = null;
                    },
                    onloaderror: function(id, error) {
                        console.error('Error loading audio:', error);
                        alert('Error loading audio file: ' + currentTrackInfo.path);
                        updatePlaybackButton(false);
                        if (currentButton) {
                            updatePlayButton(currentButton, false);
                        }
                        currentButton = null;
                        currentHowl = null;
                    },
                    onplayerror: function(id, error) {
                        console.error('Error playing audio:', error);
                        alert('Error playing audio file. The file may not exist or be accessible.');
                        updatePlaybackButton(false);
                        if (currentButton) {
                            updatePlayButton(currentButton, false);
                        }
                        currentButton = null;
                        currentHowl = null;
                    }
                });
                
                // Play the recreated audio
                currentHowl.play();
            }
        }

        // Update bottom playback button
        function updatePlaybackButton(isPlaying) {
            const btn = document.getElementById('playbackMainBtn');
            const icon = btn.querySelector('.material-icons');
            
            if (isPlaying) {
                icon.textContent = 'pause';
            } else {
                icon.textContent = 'play_arrow';
            }
        }

        // Set playback volume from bottom control
        function setPlaybackVolume(volume) {
            globalVolumeLevel = volume / 100;
            document.getElementById('globalVolumeText').textContent = Math.round(volume) + '%';
            document.getElementById('globalVolume').value = volume;
            
            if (currentHowl) {
                // Get the individual volume slider value
                const currentButton = document.querySelector('.play-btn.playing');
                if (currentButton) {
                    const soundId = currentButton.id.replace('btn_', '');
                    const individualSlider = document.getElementById('vol_' + soundId);
                    if (individualSlider) {
                        const individualVolume = individualSlider.value / 100;
                        currentHowl.volume(globalVolumeLevel * individualVolume);
                    } else {
                        currentHowl.volume(globalVolumeLevel);
                    }
                } else {
                    // If no current button (replaying from playback control), just use global volume
                    currentHowl.volume(globalVolumeLevel);
                }
            }
        }

        // Progress tracking
        function startProgressTracking() {
            stopProgressTracking();
            progressInterval = setInterval(updateProgress, 100); // Update every 100ms for smoother progress
        }

        function stopProgressTracking() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        function updateProgress() {
            if (currentHowl) {
                const seek = currentHowl.seek() || 0;
                const duration = currentHowl.duration() || 0;
                
                // Update time displays
                document.getElementById('currentTime').textContent = formatTime(seek);
                document.getElementById('totalTime').textContent = formatTime(duration);
                
                // Update progress bar
                const progress = duration > 0 ? (seek / duration) * 100 : 0;
                document.getElementById('progressFill').style.width = progress + '%';
            }
        }

        // Format time for display
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }

        // Seek to position
        function seekTo(event) {
            if (currentHowl && currentHowl.duration() > 0) {
                const progressBar = event.currentTarget;
                const rect = progressBar.getBoundingClientRect();
                const percent = (event.clientX - rect.left) / rect.width;
                const duration = currentHowl.duration();
                const seekTime = duration * percent;
                
                const wasPlaying = currentHowl.playing();
                currentHowl.seek(seekTime);
                
                // If audio was paused, we need to update the progress manually
                if (!wasPlaying) {
                    updateProgress();
                }
                
                // Ensure the button states are synchronized
                if (currentButton) {
                    updatePlayButton(currentButton, wasPlaying);
                    updatePlaybackButton(wasPlaying);
                }
            }
        }


        // Update the existing togglePlay function to integrate with bottom control
        const originalTogglePlay = togglePlay;
        togglePlay = function(audioPath, soundId, button) {
            // Call original function
            originalTogglePlay(audioPath, soundId, button);
            
            // Show bottom control when playing
            if (currentHowl) {
                const soundName = button.closest('.sound-item').querySelector('.sound-name').textContent;
                const isInBGM = button.closest('#bgm-content') !== null;
                
                showPlaybackControl({
                    displayName: soundName,
                    type: isInBGM ? 'bgm' : 'sfx',
                    path: audioPath
                });
                
                // Update bottom control button state
                updatePlaybackButton(currentHowl.playing());
            }
        };

        // Update the existing stopCurrentAudio function
        const originalStopCurrentAudio = stopCurrentAudio;
        stopCurrentAudio = function() {
            originalStopCurrentAudio();
            hidePlaybackControl();
        };

        // Update the existing updatePlayButton function to sync with bottom control
        const originalUpdatePlayButton = updatePlayButton;
        updatePlayButton = function(button, isPlaying) {
            originalUpdatePlayButton(button, isPlaying);
            
            // Sync with bottom control if this is the current track
            if (button === currentButton) {
                updatePlaybackButton(isPlaying);
            }
        };

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space' && currentHowl) {
                e.preventDefault();
                togglePlaybackControl();
            }
        });

        // Copy audio ID (filename) to clipboard
        function copyAudioId(filename, button) {
            if (!filename) {
                console.warn('No filename provided for copying');
                return;
            }
            
            // Extract just the filename without path
            let audioId = filename.split('/').pop().split('\\').pop();
            
            // Remove file extension
            const lastDotIndex = audioId.lastIndexOf('.');
            if (lastDotIndex > 0) {
                audioId = audioId.substring(0, lastDotIndex);
            }
            
            // Try to use the modern Clipboard API first
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(audioId).then(() => {
                    showCopyFeedback(button, audioId);
                }).catch(err => {
                    console.error('Failed to copy using Clipboard API:', err);
                    fallbackCopyTextToClipboard(audioId, button);
                });
            } else {
                // Fallback for older browsers or non-secure contexts
                fallbackCopyTextToClipboard(audioId, button);
            }
        }

        // Fallback copy method for older browsers
        function fallbackCopyTextToClipboard(text, button) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // Avoid scrolling to bottom
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopyFeedback(button, text);
                } else {
                    console.error('Fallback copy failed');
                    alert('Failed to copy audio ID. Please copy manually: ' + text);
                }
            } catch (err) {
                console.error('Fallback copy error:', err);
                alert('Failed to copy audio ID. Please copy manually: ' + text);
            }
            
            document.body.removeChild(textArea);
        }

        // Show visual feedback when copying
        function showCopyFeedback(button, copiedText) {
            // Find the button element if event target was the icon
            const copyButton = button.closest('.copy-id-btn') || button.closest('.playback-btn') || button;
            
            // Add copied class for visual feedback
            copyButton.classList.add('copied');
            
            // Change icon temporarily
            const icon = copyButton.querySelector('.material-icons');
            const originalIcon = icon.textContent;
            icon.textContent = 'check';
            
            // Show tooltip-like feedback
            const originalTitle = copyButton.title;
            copyButton.title = `Copied: ${copiedText}`;
            
            // Reset after 2 seconds
            setTimeout(() => {
                copyButton.classList.remove('copied');
                icon.textContent = originalIcon;
                copyButton.title = originalTitle;
            }, 2000);
            
            console.log('Copied audio ID to clipboard:', copiedText);
        }
    </script>
</body>
</html>